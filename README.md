# load-balancer

å‡ ç§è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•

## ç®€å•è½®è¯¢

[ç¤ºä¾‹ä»£ç ](./php/Robin/SimpleRoundRobin.php)

ä¼˜ç‚¹ï¼š
- ç®€å•æ˜äº†

ç¼ºç‚¹ï¼š
- ä¸æ”¯æŒé…ç½®æƒé‡

## åŠ æƒè½®è¯¢

[ç¤ºä¾‹ä»£ç ](./php/Robin/WeightedRoundRobin.php)

ä¼˜ç‚¹ï¼š
- èƒ½å¤Ÿé…ç½®æƒé‡  

ç¼ºç‚¹ï¼š
- è™½ç„¶æ”¯æŒäº†æƒé‡ï¼Œä½†æ˜¯è´Ÿè½½ä¸å‡è¡¡ã€‚å½“æƒé‡åå·®è¶Šå¤§æ—¶ï¼Œåç§»è¶Šä¸¥é‡ï¼Œæ¯”å¦‚ä¼šå‡ºç° {c, b, a, a, a, a, a} æƒ…å†µ

å‚è€ƒæ–‡çŒ®ï¼š

- [è´Ÿè½½å‡è¡¡ç®—æ³• â€” è½®è¯¢](https://www.fanhaobai.com/2018/11/load-balance-round-robin.html)

## å¹³æ»‘åŠ æƒè½®è¯¢

[ç¤ºä¾‹ä»£ç ](./php/Robin/SmoothWeightedRoundRobin.php)

ä¼˜ç‚¹ï¼š
- èƒ½å¤Ÿé…ç½®æƒé‡
- å°±ç®—æ˜¯æƒé‡åå·®å¾ˆå¤§ï¼Œä¹Ÿèƒ½å¤Ÿåšåˆ°å°½å¯èƒ½çš„è´Ÿè½½å‡è¡¡ï¼Œæ¯”å¦‚ { a, a, b, a, c, a, a } æƒ…å†µ

å‚è€ƒæ–‡çŒ®ï¼š

- [nginx å¹³æ»‘åŠ æƒè½®è¯¢æºç ](https://github.com/nginx/nginx/blob/master/src/http/ngx_http_upstream_round_robin.c#L522)
- [ç›¸å…³ç®—æ³•è¯¦è§è¿™ä¸ª commit](https://github.com/phusion/nginx/commit/27e94984486058d73157038f7950a0a36ecc6e35)
- [è´Ÿè½½å‡è¡¡ç®—æ³• â€” å¹³æ»‘åŠ æƒè½®è¯¢](https://www.fanhaobai.com/2018/12/load-balance-smooth-weighted-round-robin.html)
- [å…³äºéªŒè¯è¯¥ç®—æ³•æƒé‡åˆç†æ€§ä»¥åŠå¹³æ»‘æ€§ï¼Œå¯ä»¥å‚è€ƒè¿™ä½ç½‘å‹çš„æ–‡ç«  "nginxå¹³æ»‘çš„åŸºäºæƒé‡è½®è¯¢ç®—æ³•åˆ†æ"](https://tenfy.cn/2018/11/12/smooth-weighted-round-robin/) ï¼ˆè™½ç„¶æ²¡æœ‰çœ‹æ‡‚ï¼Œå“ˆå“ˆğŸ˜„ï¼‰

ä»¥ä¸‹æ˜¯ä¸ªäººçš„ç†è§£ï¼š  

> ä¸‹é¢æ‰€è¯´çš„æ¯”è¾ƒè¿‡ç¨‹æŒ‡çš„æ˜¯ä»£ç ä¸­çš„ `$this->servers[$key]['current_weight'] > $this->best['current_weight']` è¿™ä¸€è¡Œã€‚ï¼ˆå†³å®šäº†é€‰æ‹© bestï¼‰


| èŠ‚ç‚¹  | é…ç½®æƒé‡ weight | æœ‰æ•ˆæƒé‡ effective_weightï¼ˆåˆå§‹å€¼ç­‰äº weightï¼‰ | å½“å‰æƒé‡ current_weight ï¼ˆæ¯æ¬¡é€‰æ‹©èŠ‚ç‚¹æ—¶ current_weight += effective_weightï¼‰ |
|-----|----------------------------|-------------------------------------|------------------------------------------------------------------|
| a   | 5                          | 5                                   | 0                                                                | 
| b | 1                          | 1                                   | 0                                                                | 
| c | 1                          | 1                                   | 0                                                                |

ç¬¬ä¸€è½®ï¼š

åˆå§‹æƒé‡ current_weight éƒ½ä¸º 0  
0  0  0  
æ¯”è¾ƒè¿‡ç¨‹ï¼š  
key=0 ==> 5=0+5 >    
key=1 ==> 1=0+1 > 5  
key=2 ==> 1=0+1 > 5  

æ­¤æ—¶ `best = null` å› æ­¤æ­¤æ—¶ç¬¬ä¸€è½®çš„ç¬¬ä¸€æ¬¡å¾ªç¯å°±æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ aï¼Œä¸”åˆå› ä¸º **1 > 5 å’Œ 1 > 5** éƒ½ä¸æˆç«‹ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º a  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š   
-2  1  1

---

ç¬¬äºŒè½®ï¼š

key=0 ==> 3=-2+5 > -2  
key=1 ==> 2=1+1  > 3  
key=2 ==> 2=1+1  > 3    

æ­¤æ—¶åªæœ‰ä¸€ä¸ªæ¡ä»¶ç¬¦åˆ **3 > -2**ï¼Œå› æ­¤æ­¤æ—¶ best ä¸º a  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š   
-4  2  2  

---

ç¬¬ä¸‰è½®ï¼š

key=0 ==> 1=-4+5 > -4  
key=1 ==> 3=2+1  > 1  
key=2 ==> 3=2+1  > 3  

æ­¤æ—¶æœ‰ä¸¤ä¸ªæ¡ä»¶ **1 > -4 å’Œ 3 > 1** æˆç«‹ï¼Œä½†å› ä¸ºæ­¤æ—¶æ˜¯å¾ªç¯ï¼Œå› æ­¤åé¢ä¼šè¦†ç›–å‰é¢çš„ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º b  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š  
1  -4  3  

---

ç¬¬å››è½®ï¼š

key=0 ==> 6=1+5   > -4  
key=1 ==> -3=-4+1 > 6  
key=2 ==> 4=3+1   > 6  

æ­¤æ—¶ **6 > -4** æˆç«‹ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º a  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š  
-1  -3  4  

---

ç¬¬äº”è½®ï¼š

key=0 ==> 4=-1+5  > -1  
key=1 ==> -2=-3+1 > 4  
key=2 ==> 5=4+1   > 4  

æ­¤æ—¶æœ‰ä¸¤ä¸ªæ¡ä»¶ **4 > -1 å’Œ 5 > 4** æˆç«‹ï¼Œä½†å› ä¸ºæ­¤æ—¶æ˜¯å¾ªç¯ï¼Œå› æ­¤åé¢ä¼šè¦†ç›–å‰é¢çš„ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º c  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š   
4  -2  -2  

---

ç¬¬å…­è½®ï¼š

key=0 ==> 9=4+5 > -2  
key=1 ==> -1=-2+1 > 9  
key=2 ==> -1=-2+1 > 9  

æ­¤æ—¶ **9 > -2** æˆç«‹ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º a   
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š  
2  -1  -1  

---

ç¬¬ä¸ƒè½®ï¼š

key=0 ==> 7=2+5 > 2  
key=1 ==> 0=-1+1 > 7  
key=2 ==> 0=-1+1 > 7  

æ­¤æ—¶ **7 > 2** æˆç«‹ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º a  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š  
0  0  0  

---

ç¬¬å…«è½®ï¼š

key=0 ==> 5=0+5 > 0  
key=1 ==> 1=0+1 > 5  
key=2 ==> 1=0+1 > 5  

æ­¤æ—¶ä¸ºç¬¬ 2 ä¸ªè½®è¯¢å‘¨æœŸå¼€å§‹ï¼Œå½“å‰æƒé‡ current_weight æ¢å¤åˆ°åˆå§‹çŠ¶æ€ï¼Œæ­¤æ—¶ **5 > 0** æˆç«‹ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º a  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š  
-2  1  1   
