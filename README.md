# load-balancer

å‡ ç§è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•

> æœ¬ç¤ºä¾‹æä¾›äº† [php ç‰ˆæœ¬](./php/Robin) å’Œ [golang ç‰ˆæœ¬](./golang/robin)

## ç®€å•è½®è¯¢

[ç¤ºä¾‹ä»£ç ](./php/Robin/SimpleRoundRobin.php)

ä¼˜ç‚¹ï¼š
- ç®€å•æ˜äº†

ç¼ºç‚¹ï¼š
- ä¸æ”¯æŒé…ç½®æƒé‡

## åŠ æƒè½®è¯¢

[ç¤ºä¾‹ä»£ç ](./php/Robin/WeightedRoundRobin.php)

ä¼˜ç‚¹ï¼š
- èƒ½å¤Ÿé…ç½®æƒé‡  

ç¼ºç‚¹ï¼š
- è™½ç„¶æ”¯æŒäº†æƒé‡ï¼Œä½†æ˜¯è´Ÿè½½ä¸å‡è¡¡ã€‚å½“æƒé‡åå·®è¶Šå¤§æ—¶ï¼Œåç§»è¶Šä¸¥é‡ï¼Œæ¯”å¦‚ä¼šå‡ºç° {c, b, a, a, a, a, a} æƒ…å†µ

å‚è€ƒæ–‡çŒ®ï¼š

- [è´Ÿè½½å‡è¡¡ç®—æ³• â€” è½®è¯¢](https://www.fanhaobai.com/2018/11/load-balance-round-robin.html)

## å¹³æ»‘åŠ æƒè½®è¯¢ï¼ˆåŠ æƒåŠ¨æ€ä¼˜å…ˆçº§ç®—æ³•ï¼‰

ç®—æ³•ç‰¹ç‚¹ï¼š  
1. å½“å‰èŠ‚ç‚¹çš„å½“å‰æƒé‡ current_weight = ä¸Šä¸€æ¬¡å½“å‰èŠ‚ç‚¹çš„å½“å‰æƒé‡ current_weight + å½“å‰èŠ‚ç‚¹çš„æœ‰æ•ˆæƒé‡ effective_weight
2. æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å½“å‰æƒé‡ effective_weight å’Œä¸Šä¸€ä¸ªæœ€ä½³èŠ‚ç‚¹çš„å½“å‰æƒé‡ effective_weight åšæ¯”è¾ƒï¼Œå¦‚æœæƒé‡å€¼å¤§äºä¸Šä¸€ä¸ªæœ€ä½³èŠ‚ç‚¹çš„å½“å‰æƒé‡æ—¶ï¼Œåˆ™æ­¤èŠ‚ç‚¹ä¸ºæœ€ä½³èŠ‚ç‚¹ï¼ˆä¸€ç›´ä¼šæ¯”è¾ƒåˆ°æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœæœ‰å¤šä¸ªèŠ‚ç‚¹ç¬¦åˆæ¡ä»¶æ—¶ï¼Œé‚£ä¹ˆåˆ™ä¼šä»¥æœ€åä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ä½œä¸ºæœ€ä½³èŠ‚ç‚¹ï¼‰
3. é€‰å‡ºçš„æœ€ä½³èŠ‚ç‚¹çš„å½“å‰æƒé‡ effective_weight å‡å»æ‰€æœ‰èŠ‚ç‚¹æœ‰æ•ˆæƒé‡ä¹‹å’Œ

> å…¶å®ä¸éš¾å‘ç°ï¼Œç›´æ¥å½±å“èŠ‚ç‚¹çš„é€‰ä¸­çš„å› ç´ å°±æ˜¯èŠ‚ç‚¹çš„ effective_weight å€¼ï¼Œé‚£ä¹ˆ weight åˆæ˜¯åšå•¥çš„å‘¢ï¼Ÿå…¶å® weight å°±å•çº¯ç”¨äºä½œä¸ºåˆå§‹æƒé‡ï¼Œå¯ä»¥ç†è§£ä¸ºå°±æ˜¯å›ºå®šé…ç½®ã€‚æœ€åˆæ—¶ï¼Œeffective_weight å°±ä¸º weight çš„å€¼ï¼Œä½œä¸ºåˆå§‹å€¼ã€‚ç®—æ³•è¿ç®—è¿‡ç¨‹ä¸­æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ effective_weight çš„å€¼
> åšå˜æ›´ï¼Œè¾¾åˆ°åŠ¨æ€æ§åˆ¶æƒé‡çš„æ•ˆæœï¼Œå‡å°‘åˆ™é™ä½æƒé‡ï¼Œå¢åŠ åˆ™åŠ å¤§æƒé‡ï¼Œä½†æ˜¯å¢åŠ  effective_weight æ—¶ï¼Œä¸è¦è¶…è¿‡ weight çš„å€¼ï¼Œå¦åˆ™åˆ™æœ‰å¯èƒ½è¶…è¿‡äº†æœ€åˆçš„æ‰€æœ‰èŠ‚ç‚¹çš„æ€»æƒé‡ä¹‹å’Œï¼Œè¿™æ ·è²Œä¼¼ä¹‹å‰è®¾ç½®çš„åˆå§‹æƒé‡ weight å°±æ²¡æœ‰å¤ªå¤§çš„æ„ä¹‰äº†ã€‚æ¯”å¦‚è¯´ï¼Œåˆå§‹å€¼ weight ä¸º {a:5, b:1, c:1} æ­¤æ—¶ a èŠ‚ç‚¹
> çš„æƒé‡æ§åˆ¶åœ¨ 5/7 ï¼ˆè½®è¯¢ 7 æ¬¡æ—¶ï¼Œæœ€å¤š 5 æ¬¡å‘½ä¸­ a èŠ‚ç‚¹ï¼‰ï¼Œå¦‚æœä¸€ä¸‹å­ a çš„ effective_weight å˜æˆäº† 6 é‚£ä¹ˆåˆ™æƒé‡å°±å¯èƒ½ä¸º 6/8 æ‰“ç ´äº†åŸæ¥åˆå§‹æƒé‡çš„æ¯”ä¾‹ï¼Œå°±ä¸å¤ªç¬¦åˆåˆå§‹æƒé‡çš„è®¾æƒ³äº†ã€‚å½“ç„¶ï¼Œè¿™ä¸ªä¹Ÿè·Ÿè‡ªå·±çš„å®é™…ä¸šåŠ¡åœºæ™¯æœ‰å…³ã€‚

[ç¤ºä¾‹ä»£ç ](./php/Robin/SmoothWeightedRoundRobin.php)

ä¼˜ç‚¹ï¼š
- èƒ½å¤Ÿé…ç½®æƒé‡
- å°±ç®—æ˜¯æƒé‡åå·®å¾ˆå¤§ï¼Œä¹Ÿèƒ½å¤Ÿåšåˆ°å°½å¯èƒ½çš„è´Ÿè½½å‡è¡¡ï¼Œæ¯”å¦‚ { a, a, b, a, c, a, a } æƒ…å†µï¼Œå‡åŒ€ç¨‹åº¦æå‡çš„éå¸¸æ˜¾è‘—

å‚è€ƒæ–‡çŒ®ï¼š

- [nginx å¹³æ»‘åŠ æƒè½®è¯¢æºç ](https://github.com/nginx/nginx/blob/master/src/http/ngx_http_upstream_round_robin.c#L522)
- [ç›¸å…³ç®—æ³•è¯¦è§è¿™ä¸ª commit](https://github.com/phusion/nginx/commit/27e94984486058d73157038f7950a0a36ecc6e35)
- [è´Ÿè½½å‡è¡¡ç®—æ³• â€” å¹³æ»‘åŠ æƒè½®è¯¢](https://www.fanhaobai.com/2018/12/load-balance-smooth-weighted-round-robin.html)
- [å…³äºéªŒè¯è¯¥ç®—æ³•æƒé‡åˆç†æ€§ä»¥åŠå¹³æ»‘æ€§ï¼Œå¯ä»¥å‚è€ƒè¿™ä½ç½‘å‹çš„æ–‡ç«  "nginxå¹³æ»‘çš„åŸºäºæƒé‡è½®è¯¢ç®—æ³•åˆ†æ"](https://tenfy.cn/2018/11/12/smooth-weighted-round-robin/) ï¼ˆè™½ç„¶æ²¡æœ‰çœ‹æ‡‚è¯æ˜è¿‡ç¨‹ï¼Œå“ˆå“ˆğŸ˜„ï¼‰
- [Golangå®ç°å››ç§è´Ÿè½½å‡è¡¡ç®—æ³•](https://juejin.cn/post/6871169933150486542)

ä»¥ä¸‹æ˜¯ä¸ªäººçš„ç†è§£ï¼š  

> ä¸‹é¢æ‰€è¯´çš„æ¯”è¾ƒè¿‡ç¨‹æŒ‡çš„æ˜¯ä»£ç ä¸­çš„ `$this->servers[$key]['current_weight'] > $this->best['current_weight']` è¿™ä¸€è¡Œã€‚ï¼ˆå†³å®šäº†é€‰æ‹© bestï¼‰


| èŠ‚ç‚¹  | é…ç½®æƒé‡ weight | æœ‰æ•ˆæƒé‡ effective_weightï¼ˆåˆå§‹å€¼ç­‰äº weightï¼‰ | å½“å‰æƒé‡ current_weight ï¼ˆæ¯æ¬¡é€‰æ‹©èŠ‚ç‚¹æ—¶ current_weight += effective_weightï¼‰ |
|-----|----------------------------|-------------------------------------|------------------------------------------------------------------|
| a   | 5                          | 5                                   | 0                                                                | 
| b | 1                          | 1                                   | 0                                                                | 
| c | 1                          | 1                                   | 0                                                                |

ç¬¬ä¸€è½®ï¼š

åˆå§‹æƒé‡ current_weight éƒ½ä¸º 0  
0  0  0  
æ¯”è¾ƒè¿‡ç¨‹ï¼š  
key=0 ==> 5=0+5 >    
key=1 ==> 1=0+1 > 5  
key=2 ==> 1=0+1 > 5  

æ­¤æ—¶ `best = null` å› æ­¤æ­¤æ—¶ç¬¬ä¸€è½®çš„ç¬¬ä¸€æ¬¡å¾ªç¯å°±æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ aï¼Œä¸”åˆå› ä¸º **1 > 5 å’Œ 1 > 5** éƒ½ä¸æˆç«‹ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º a  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š   
-2  1  1

---

ç¬¬äºŒè½®ï¼š

key=0 ==> 3=-2+5 > -2  
key=1 ==> 2=1+1  > 3  
key=2 ==> 2=1+1  > 3    

æ­¤æ—¶åªæœ‰ä¸€ä¸ªæ¡ä»¶ç¬¦åˆ **3 > -2**ï¼Œå› æ­¤æ­¤æ—¶ best ä¸º a  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š   
-4  2  2  

---

ç¬¬ä¸‰è½®ï¼š

key=0 ==> 1=-4+5 > -4  
key=1 ==> 3=2+1  > 1  
key=2 ==> 3=2+1  > 3  

æ­¤æ—¶æœ‰ä¸¤ä¸ªæ¡ä»¶ **1 > -4 å’Œ 3 > 1** æˆç«‹ï¼Œä½†å› ä¸ºæ­¤æ—¶æ˜¯å¾ªç¯ï¼Œå› æ­¤åé¢ä¼šè¦†ç›–å‰é¢çš„ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º b  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š  
1  -4  3  

---

ç¬¬å››è½®ï¼š

key=0 ==> 6=1+5   > -4  
key=1 ==> -3=-4+1 > 6  
key=2 ==> 4=3+1   > 6  

æ­¤æ—¶ **6 > -4** æˆç«‹ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º a  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š  
-1  -3  4  

---

ç¬¬äº”è½®ï¼š

key=0 ==> 4=-1+5  > -1  
key=1 ==> -2=-3+1 > 4  
key=2 ==> 5=4+1   > 4  

æ­¤æ—¶æœ‰ä¸¤ä¸ªæ¡ä»¶ **4 > -1 å’Œ 5 > 4** æˆç«‹ï¼Œä½†å› ä¸ºæ­¤æ—¶æ˜¯å¾ªç¯ï¼Œå› æ­¤åé¢ä¼šè¦†ç›–å‰é¢çš„ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º c  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š   
4  -2  -2  

---

ç¬¬å…­è½®ï¼š

key=0 ==> 9=4+5 > -2  
key=1 ==> -1=-2+1 > 9  
key=2 ==> -1=-2+1 > 9  

æ­¤æ—¶ **9 > -2** æˆç«‹ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º a   
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š  
2  -1  -1  

---

ç¬¬ä¸ƒè½®ï¼š

key=0 ==> 7=2+5 > 2  
key=1 ==> 0=-1+1 > 7  
key=2 ==> 0=-1+1 > 7  

æ­¤æ—¶ **7 > 2** æˆç«‹ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º a  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š  
0  0  0  

---

ç¬¬å…«è½®ï¼š

key=0 ==> 5=0+5 > 0  
key=1 ==> 1=0+1 > 5  
key=2 ==> 1=0+1 > 5  

æ­¤æ—¶ä¸ºç¬¬ 2 ä¸ªè½®è¯¢å‘¨æœŸå¼€å§‹ï¼Œå½“å‰æƒé‡ current_weight æ¢å¤åˆ°åˆå§‹çŠ¶æ€ï¼Œæ­¤æ—¶ **5 > 0** æˆç«‹ï¼Œå› æ­¤æ­¤æ—¶ best å°±ä¸º a  
é€‰æ‹©åå„èŠ‚ç‚¹ current_weight åˆ†åˆ«ä¸ºï¼š  
-2  1  1   
