<?php
/**
 *
 *
 * Created by PhpStorm
 * User: Alex
 * Date: 2023-07-25 21:09
 */
declare(strict_types=1);

include_once __DIR__ . '/ConsistentHashing.php';

class ConsistentHashTest
{

    public function testConsistentHashing()
    {
        $con = new ConsistentHashing(3);

        $nodes = [
            '192.168.0.1',
            '192.168.0.2',
            '192.168.0.3',
            '192.168.0.4',
            '192.168.0.5',
        ];

        foreach ($nodes as $node) {
            $con->addNode($node);
        }

        $expectedNodes = [
            'apple' => '192.168.0.1',
            'banana' => '192.168.0.5',
            'cherry' => '192.168.0.5',
            'grape' => '192.168.0.4',
            'orange' => '192.168.0.2',
            'pear' => '192.168.0.3',
        ];

        foreach ($expectedNodes as $k => $v) {
            $hit = $con->lookup($k);
            if ($v !== $hit) {
                echo 'k =>' . $k . '期望落在[' . $v . '] 实际落在[' . $hit . ']' . PHP_EOL;
            }
        }

        $a = $con->toArray();
        print_r($a);

        // Array
        // (
        //     [replicas] => 3
        //     [hash_map] => Array
        //         (
        //             [195176557] => 192.168.0.5
        //             [214953076] => 192.168.0.1
        //             [486124976] => 192.168.0.4
        //             [671928576] => 192.168.0.2
        //             [1594614166] => 192.168.0.3
        //             [1811848486] => 192.168.0.5
        //             [1821595967] => 192.168.0.1
        //             [2091194619] => 192.168.0.4
        //             [2191341587] => 192.168.0.3
        //             [2512829902] => 192.168.0.2
        //             [2969927866] => 192.168.0.1
        //             [3060286627] => 192.168.0.5
        //             [3245306933] => 192.168.0.4
        //             [3804335448] => 192.168.0.3
        //             [4120512645] => 192.168.0.2
        //         )
        //
        //     [nodes] => Array
        //         (
        //             [192.168.0.1] => Array
        //                 (
        //                     [0] => 1821595967
        //                     [1] => 2969927866
        //                     [2] => 214953076
        //                 )
        //
        //             [192.168.0.2] => Array
        //                 (
        //                     [0] => 4120512645
        //                     [1] => 671928576
        //                     [2] => 2512829902
        //                 )
        //
        //             [192.168.0.3] => Array
        //                 (
        //                     [0] => 2191341587
        //                     [1] => 1594614166
        //                     [2] => 3804335448
        //                 )
        //
        //             [192.168.0.4] => Array
        //                 (
        //                     [0] => 486124976
        //                     [1] => 3245306933
        //                     [2] => 2091194619
        //                 )
        //
        //             [192.168.0.5] => Array
        //                 (
        //                     [0] => 1811848486
        //                     [1] => 3060286627
        //                     [2] => 195176557
        //                 )
        //
        //         )
        //
        // )

        $con->removeNode('192.168.0.3');
        $b = $con->toArray();
        print_r($b);

        // Array
        // (
        //     [replicas] => 3
        //     [hash_map] => Array
        //         (
        //             [195176557] => 192.168.0.5
        //             [214953076] => 192.168.0.1
        //             [486124976] => 192.168.0.4
        //             [671928576] => 192.168.0.2
        //             [1811848486] => 192.168.0.5
        //             [1821595967] => 192.168.0.1
        //             [2091194619] => 192.168.0.4
        //             [2512829902] => 192.168.0.2
        //             [2969927866] => 192.168.0.1
        //             [3060286627] => 192.168.0.5
        //             [3245306933] => 192.168.0.4
        //             [4120512645] => 192.168.0.2
        //         )
        //
        //     [nodes] => Array
        //         (
        //             [192.168.0.1] => Array
        //                 (
        //                     [0] => 1821595967
        //                     [1] => 2969927866
        //                     [2] => 214953076
        //                 )
        //
        //             [192.168.0.2] => Array
        //                 (
        //                     [0] => 4120512645
        //                     [1] => 671928576
        //                     [2] => 2512829902
        //                 )
        //
        //             [192.168.0.4] => Array
        //                 (
        //                     [0] => 486124976
        //                     [1] => 3245306933
        //                     [2] => 2091194619
        //                 )
        //
        //             [192.168.0.5] => Array
        //                 (
        //                     [0] => 1811848486
        //                     [1] => 3060286627
        //                     [2] => 195176557
        //                 )
        //
        //         )
        //
        // )

    }

}

$t = new ConsistentHashTest();
$t->testConsistentHashing();